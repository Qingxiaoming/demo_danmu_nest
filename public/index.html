<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>----</title>
    <link rel="stylesheet" href="styles.css">
    
</head>
<body>
    <h1></h1>
    <div class="login-container">
        <input type="password" id="login-password" placeholder="输入密码">
        <button id="login-btn">Start</button>
        <script>
            document.getElementById('login-password').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('login-btn').click();
                }
            });
        </script>
        
    </div>
    <div class="toggle-container">
        <button id="toggle-btn">O</button>
        <div id="password-error" class="error-message"></div>
    </div>
    <div id="danmu-container"></div>
    <div class="add-danmu-btn-container" style="display: none;">
        <button id="add-danmu-btn" title="添加弹幕"><i class="fas fa-plus"></i></button>
        <button id="settings-btn" title="设置"><i class="fas fa-cog"></i></button>
    </div>
    <div id="server-error" class="error-message" style="display: none;">服务器未连接</div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script>

        const danmuContainer = document.getElementById('danmu-container');
        const serverErrorElement = document.getElementById('server-error'); // 定义全局变量

        const socket = io('http://127.0.0.1:5052');
        let userRole = 'guest'; // 默认为游客模式
        let showNonWaiting = true; // 默认显示所有状态
        let currentSelectedDanmuItem = null; // 全局变量，用于追踪当前选中的弹幕项目
        let currentDanmuData = null;// 全局变量存储最新的弹幕数据
        let isConnected = false; // 添加连接状态标志

        socket.on('connect', () => {
            console.log('连接到 Socket.IO 服务器');
            serverErrorElement.style.display = 'none'; // 使用全局变量
            isConnected = true; // 设置连接状态为已连接
        });

        socket.on('connect_error', (error) => {
            console.log('连接到 Socket.IO 服务器失败', error);
            serverErrorElement.style.display = 'block'; // 使用全局变量
            isConnected = false; // 设置连接状态为未连接
        });

        socket.on('disconnect', () => {
            console.log('与 Socket.IO 服务器断开连接');
            serverErrorElement.style.display = 'block'; // 使用全局变量
            isConnected = false; // 设置连接状态为未连接
        });

        // 初始化Socket事件监听
        setupSocketEvents();

        // 添加点击列表外失焦的逻辑
        document.addEventListener('click', (e) => {
            // 检查点击是否发生在弹幕项目外部
            if (currentSelectedDanmuItem && !e.target.closest('.danmu-item') && !e.target.closest('.acps-dialog') && !e.target.closest('.acps-dialog-overlay')) {
                // 如果点击在弹幕项目外部且不在对话框内，取消选中状态
                currentSelectedDanmuItem.classList.remove('selected');
                currentSelectedDanmuItem.blur();
                currentSelectedDanmuItem = null;
            }
        });

        // 全局快捷键监听
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'i') {
                e.preventDefault();
                showSettingsDialog();
            } else if (e.ctrlKey && e.key.toLowerCase() === 'a') {
                e.preventDefault();
                showAddDanmuDialog();
            } else if (e.ctrlKey && e.key.toLowerCase() === 't') {
                e.preventDefault();
                document.getElementById('toggle-btn').click();
            }
        });
        // 设置按钮点击事件
        document.getElementById('settings-btn').onclick = () => {
            showSettingsDialog();
        };
        // 添加弹幕按钮点击事件
        document.getElementById('add-danmu-btn').onclick = () => {
            showAddDanmuDialog();
        };

        //切换列表显示函数
        document.getElementById('toggle-btn').onclick = () => {
            showNonWaiting = !showNonWaiting; // 切换显示/隐藏状态
            renderDanmu(); // 重新渲染弹幕
        };

        // 处理弹幕项选择的通用函数
        function handleDanmuItemSelection(item) {
            if (currentSelectedDanmuItem && (currentSelectedDanmuItem !== item)) {
                currentSelectedDanmuItem.classList.remove('selected');
                //currentSelectedDanmuItem.blur();
            }
            item.classList.add('selected');
            item.focus();
            currentSelectedDanmuItem = item;
        }

        // 处理Tab键导航的通用函数
        function handleTabNavigation(item, e) {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('.danmu-item'));
            const currentIndex = items.indexOf(item);
            let nextIndex;
            if (e.shiftKey) {
                nextIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
            } else {
                nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
            }
            const nextItem = items[nextIndex];
            if (nextItem) {
                handleDanmuItemSelection(nextItem);
            }
        }




        //管理员id验证函数
        document.getElementById('login-btn').onclick = () => {
            const plainPassword = document.getElementById('login-password').value;
            if (!plainPassword) {
                const errorElement = document.getElementById('password-error');
                errorElement.textContent = '密码为空';
                errorElement.classList.add('show');
                setTimeout(() => {
                    errorElement.classList.remove('show');
                }, 3000);
                return;
            }
            // 对密码进行SHA-256哈希处理
            const hashedPassword = CryptoJS.SHA256(plainPassword).toString();
            
            // 发送哈希后的密码到后端进行验证
            socket.emit('verify_password', { password: hashedPassword, hashed: true });
            
            socket.once('verify_password', (response) => {
                if (response.success) {
                    userRole = 'owner';
                    document.querySelector('.add-danmu-btn-container').style.display = 'block';
                    renderDanmu();
                    document.getElementById('password-error').classList.remove('show');
                } else {
                    const errorElement = document.getElementById('password-error');
                    errorElement.textContent = response.message || '密码错误';
                    errorElement.classList.add('show');
                    setTimeout(() => {
                        errorElement.classList.remove('show');
                    }, 3000);
                }
            });
        };



        // 使用函数封装Socket.IO事件处理逻辑
        function setupSocketEvents() {
            // 定义所有需要监听的事件
            const socketEvents = [
                'update', 'get_acps', 'update_acps', 'add_danmu'
            ];
            // 为每个事件添加监听器
            socketEvents.forEach(eventName => {
                socket.on(eventName, (data) => {
                    handleSocketEvent(eventName, data);
                });
            });
        }
        
        // 使用switch-case处理不同的Socket.IO事件
        function handleSocketEvent(eventName, data) {
            switch(eventName) {
                case 'update':
                    currentDanmuData = data; // 保存最新数据
                    renderDanmu(data);
                    break;
                    
                case 'get_acps':
                    console.log('收到账密数据:', data);
                    if (data && data.data) {
                        showAccountPasswordDialog(data.data, data.uid);
                    }
                    break;
                    
                case 'update_acps':
                    break;
                    
                case 'add_danmu':
                    break;
                    
                default:
                    console.log(`未处理的事件: ${eventName}`, data);
                    break;
            }
        }
        
        function renderDanmu(data) {
            // 如果没有传入数据，使用最新保存的数据
            if (!data) {
                data = currentDanmuData;
            }
            // 如果没有数据可用，直接返回
            if (!data || !data.uid) return;
            
            // 保存当前选中项的信息
            let selectedUid = null;
            if (currentSelectedDanmuItem) {
                // 获取当前选中项的uid属性
                selectedUid = currentSelectedDanmuItem.getAttribute('data-uid');
                // 如果没有uid属性，尝试通过索引获取
                if (!selectedUid) {
                    const items = Array.from(document.querySelectorAll('.danmu-item'));
                    const selectedIndex = items.indexOf(currentSelectedDanmuItem);
                    if (selectedIndex !== -1 && selectedIndex < data.uid.length) {
                        selectedUid = data.uid[selectedIndex];
                    }
                }
            }
            
            danmuContainer.innerHTML = ''; // 清空现有内容
            data.uid.forEach((uid, index) => {
                if (!showNonWaiting && data.status[index] !== 'waiting') {
                    return; // 如果隐藏非等待状态且当前状态不是 'waiting'，则跳过
                }
                // 如果状态为notdisplay，跳过该项不显示
                if (data.status[index] === 'notdisplay') {
                    return;
                }
                const item = document.createElement('div');
                item.className = 'danmu-item';
                // 添加点击事件处理
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDanmuItemSelection(item);
                });
                // 修改tabIndex以支持Tab键导航
                item.tabIndex = 0;
                // 优化Tab键导航
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        handleTabNavigation(item, e);
                    } else if (userRole === 'owner') {
                        switch(e.key) {
                            case '1':
                                socket.emit('delete', { index: uid });
                                break;
                            case '2':
                                socket.emit('completed', { index: uid });
                                break;
                            case '3':
                                const newText = prompt('请输入新的弹幕内容:', data.text[index]);
                                if (newText) {
                                    socket.emit('edit', { index: uid, text: newText });
                                }
                                break;
                            case '4':
                                socket.emit('get_acps', { index: uid });
                                break;
                        }
                    }
                });

                // 添加焦点事件处理
                item.addEventListener('focus', () => {
                    handleDanmuItemSelection(item);
                });
                
                // 存储uid属性，用于后续恢复选中状态
                item.setAttribute('data-uid', uid);

                // 昵称
                const nickname = document.createElement('span');
                nickname.textContent = `${data.nickname[index]}: `;
                nickname.className = 'nickname';

                // 弹幕内容
                const text = document.createElement('span');
                text.textContent = `${data.text[index]}`;
                text.className = 'text';

                // 状态
                const status = document.createElement('span');
                status.textContent = `      ${data.status[index]}`;
                status.className = 'status';

                // 创建时间
                const createtime = document.createElement('span');
                createtime.textContent = `----${data.createtime[index].slice(5, 16)}`;
                createtime.className = 'createtime';

                // 如果用户是"主人"，显示操作按钮
                if (userRole === 'owner') {
                    const actions = document.createElement('div');
                    actions.className = 'actions';

                    // 删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '删除';
                    deleteBtn.onclick = () => {
                        socket.emit('delete', {
                            index: uid 
                        });
                    };

                    // 编辑按钮
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '编辑';
                    editBtn.onclick = () => {
                        const newText = prompt('请输入新的弹幕内容:', data.text[index]);
                        if (newText) {
                            socket.emit('edit', {
                                index: uid, 
                                text: newText
                            });
                        }
                    };

                    // 完成按钮
                    const completedBtn = document.createElement('button');
                    completedBtn.textContent = '完成';
                    completedBtn.onclick = () => {
                        socket.emit('completed', {
                            index: uid 
                        });
                    };
                    // 账密按钮
                    const ac_ps_Btn = document.createElement('button');
                    ac_ps_Btn.textContent = '账密';
                    ac_ps_Btn.onclick = () => {
                        // 然后发送WebSocket事件获取数据
                        socket.emit('get_acps', {
                            index: uid
                        });
                    };
                    actions.appendChild(deleteBtn);
                    actions.appendChild(completedBtn);
                    actions.appendChild(editBtn);
                    actions.appendChild(ac_ps_Btn);
                    item.appendChild(actions);
                }

                item.appendChild(nickname);
                item.appendChild(text);
                item.appendChild(status);
                item.appendChild(createtime);

                danmuContainer.appendChild(item);
                
                // 如果这个项目是之前选中的项目，恢复选中状态
                if (selectedUid && uid === selectedUid) {
                    currentSelectedDanmuItem = item;
                    item.classList.add('selected');
                    // 使用setTimeout确保DOM完全渲染后再设置焦点
                    setTimeout(() => {
                        item.focus();
                    }, 0);
                }
            });
            
            // 如果渲染后没有找到之前选中的项目（可能因为过滤或其他原因），但有其他项目可选
            if (selectedUid && !currentSelectedDanmuItem && danmuContainer.children.length > 0) {
                // 选择第一个可见的项目
                const firstItem = danmuContainer.children[0];
                currentSelectedDanmuItem = firstItem;
                firstItem.classList.add('selected');
                setTimeout(() => {
                    firstItem.focus();
                }, 0);
            }
        }


        // 显示添加弹幕对话框
        function showAddDanmuDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'acps-dialog-overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <h3>添加弹幕</h3>
                <input type="text" id="add-nickname" placeholder="输入昵称">
                <input type="text" id="add-text" placeholder="输入弹幕内容">
                <button id="add-save">保存</button>
                <button id="add-cancel">取消</button>
            `;

            // 添加延时以触发动画
            requestAnimationFrame(() => {
                overlay.classList.add('show');
                dialog.classList.add('show');
            });

            const saveButton = dialog.querySelector('#add-save');
            const cancelButton = dialog.querySelector('#add-cancel');
            const nicknameField = dialog.querySelector('#add-nickname');
            const textField = dialog.querySelector('#add-text');

            // 添加键盘事件监听
            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    saveButton.click();
                } else if (e.key === 'Escape') {
                    cancelButton.click();
                }
            };
            document.addEventListener('keydown', handleKeydown);

            saveButton.onclick = () => {
                const nickname = nicknameField.value;
                const text = textField.value;
                if (nickname && text) {
                    socket.emit('add_danmu', {
                        nickname: nickname,
                        text: text
                    });
                    closeDialog();
                } else {
                    alert('昵称和弹幕内容不能为空');
                }
            };

            cancelButton.onclick = () => {
                closeDialog();
            };

            const closeDialog = () => {
                document.removeEventListener('keydown', handleKeydown);
                overlay.classList.remove('show');
                dialog.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    dialog.remove();
                }, 300);
            };

            document.body.appendChild(dialog);
        }

        // 读取本地存储中的快捷键设置
        function loadShortcutSettings() {
            const settings = localStorage.getItem('shortcutSettings');
            return settings ? JSON.parse(settings) : {};
        }

        // 保存快捷键设置到本地存储
        function saveShortcutSettings(settings) {
            console.log('保存快捷键设置:', settings); // 调试输出
            localStorage.setItem('shortcutSettings', JSON.stringify(settings));
        }

        // 初始化快捷键设置
        let shortcutSettings = loadShortcutSettings();

        // 确保在 DOMContentLoaded 事件后初始化
        document.addEventListener('DOMContentLoaded', () => {
            shortcutSettings = loadShortcutSettings();
        });

        // 绑定快捷键到功能
        document.addEventListener('keydown', (e) => {
            const keyCombination = [];
            if (e.ctrlKey) keyCombination.push('Ctrl');
            if (e.shiftKey) keyCombination.push('Shift');
            if (e.altKey) keyCombination.push('Alt');
            if (e.key !== 'Control' && e.key !== 'Shift' && e.key !== 'Alt') {
                keyCombination.push(e.key.toUpperCase());
            }
            const keyString = keyCombination.join('+');

            switch (keyString) {
                case shortcutSettings.delete:
                    // 执行删除操作
                    console.log('执行删除操作');
                    break;
                case shortcutSettings.complete:
                    // 执行完成操作
                    console.log('执行完成操作');
                    break;
                case shortcutSettings.edit:
                    // 执行编辑操作
                    console.log('执行编辑操作');
                    break;
                case shortcutSettings.acps:
                    // 执行账密操作
                    console.log('执行账密操作');
                    break;
                case shortcutSettings.add:
                    // 执行增加操作
                    console.log('执行增加操作');
                    break;
            }
        });

        // 更新设置界面
        function showSettingsDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'acps-dialog-overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <h3>快捷键设置</h3>
                <div class="settings-item">
                    <label>删除快捷键：</label>
                    <input type="text" id="delete-shortcut" placeholder="请按下快捷键组合" readonly value="${shortcutSettings.delete || ''}">
                </div>
                <div class="settings-item">
                    <label>完成快捷键：</label>
                    <input type="text" id="complete-shortcut" placeholder="请按下快捷键组合" readonly value="${shortcutSettings.complete || ''}">
                </div>
                <div class="settings-item">
                    <label>编辑快捷键：</label>
                    <input type="text" id="edit-shortcut" placeholder="请按下快捷键组合" readonly value="${shortcutSettings.edit || ''}">
                </div>
                <div class="settings-item">
                    <label>账密快捷键：</label>
                    <input type="text" id="acps-shortcut" placeholder="请按下快捷键组合" readonly value="${shortcutSettings.acps || ''}">
                </div>
                <div class="settings-item">
                    <label>增加快捷键：</label>
                    <input type="text" id="add-shortcut" placeholder="请按下快捷键组合" readonly value="${shortcutSettings.add || ''}">
                </div>
                <div class="settings-actions">
                    <button id="settings-save">保存</button>
                    <button id="settings-cancel">取消</button>
                </div>
            `;

            requestAnimationFrame(() => {
                overlay.classList.add('show');
                dialog.classList.add('show');
            });

            const closeDialog = () => {
                overlay.classList.remove('show');
                dialog.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    dialog.remove();
                }, 300);
            };

            // 快捷键输入处理
            const shortcutInputs = dialog.querySelectorAll('input[type="text"]');
            shortcutInputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    e.preventDefault();
                    const keys = [];
                    if (e.ctrlKey) keys.push('Ctrl');
                    if (e.shiftKey) keys.push('Shift');
                    if (e.altKey) keys.push('Alt');
                    if (e.key !== 'Control' && e.key !== 'Shift' && e.key !== 'Alt') {
                        keys.push(e.key.toUpperCase());
                    }
                    input.value = keys.join('+');
                });
            });

            dialog.querySelector('#settings-save').onclick = () => {
                const newSettings = {
                    delete: document.getElementById('delete-shortcut').value,
                    complete: document.getElementById('complete-shortcut').value,
                    edit: document.getElementById('edit-shortcut').value,
                    acps: document.getElementById('acps-shortcut').value,
                    add: document.getElementById('add-shortcut').value
                };
                console.log('保存按钮点击，新的设置:', newSettings); // 调试输出
                saveShortcutSettings(newSettings);
                closeDialog();
            };

            dialog.querySelector('#settings-cancel').onclick = closeDialog;

            document.body.appendChild(dialog);
        }
        //账密显示函数
        function showAccountPasswordDialog(data, uid) {
            const overlay = document.createElement('div');
            overlay.className = 'acps-dialog-overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <p><span id="current-account">${data.account}</span></p>
                <p><span id="current-password">${data.password}</span></p>
                <input type="text" id="acps-edit" placeholder="输入新的账号或密码">
                <button id="acps-save">保存</button>
                <button id="acps-cancel">取消</button>
            `;

            // 添加延时以触发动画
            requestAnimationFrame(() => {
                overlay.classList.add('show');
                dialog.classList.add('show');
            });

            // 添加键盘事件监听
            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    saveButton.click();
                } else if (e.key === 'Escape') {
                    cancelButton.click();
                }
            };
            document.addEventListener('keydown', handleKeydown);

            const saveButton = dialog.querySelector('#acps-save');
            const cancelButton = dialog.querySelector('#acps-cancel');
            const inputField = dialog.querySelector('#acps-edit');

            saveButton.onclick = () => {
                const newText = inputField.value;
                if (newText) {
                    socket.emit('update_acps', {
                        index: uid,
                        text: newText
                    });
                    closeDialog();
                } else {
                    //alert('请输入新的账号或密码');
                }
            };

            cancelButton.onclick = () => {
                closeDialog();
            };
            //关闭弹出对话框
            const closeDialog = () => {
                document.removeEventListener('keydown', handleKeydown);
                overlay.classList.remove('show');
                dialog.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    dialog.remove();
                }, 300);
            };

            document.body.appendChild(dialog);
        }




    </script>
</body>
</html>
