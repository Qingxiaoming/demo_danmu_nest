<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>----</title>
    <link rel="stylesheet" href="styles.css">
    
</head>
<body>
    <h1></h1>
    <div class="login-container">
        <input type="password" id="login-password" placeholder="输入密码">
        <button id="login-btn">Start</button>
        <script>
            document.getElementById('login-password').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('login-btn').click();
                }
            });
        </script>
        
    </div>
    <div class="toggle-container">
        <button id="toggle-btn">O</button>
        <div id="password-error" class="error-message"></div>
    </div>
    <div id="danmu-container"></div>
    <div class="add-danmu-btn-container" style="display: none;">
        <button id="add-danmu-btn" title="添加弹幕"><i class="fas fa-plus"></i></button>
        <button id="settings-btn" title="设置"><i class="fas fa-cog"></i></button>
    </div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script>
        const danmuContainer = document.getElementById('danmu-container');
        const socket = io('http://127.0.0.1:5052');
        let userRole = 'guest'; // 默认为游客模式
        let showNonWaiting = true; // 默认显示所有状态

        socket.on('connect', () => {
            console.log('连接到 Socket.IO 服务器');
        });
        
        document.getElementById('login-btn').onclick = () => {
            const plainPassword = document.getElementById('login-password').value;
            if (!plainPassword) {
                const errorElement = document.getElementById('password-error');
                errorElement.textContent = '密码为空';
                errorElement.classList.add('show');
                setTimeout(() => {
                    errorElement.classList.remove('show');
                }, 3000);
                return;
            }
            
            // 对密码进行SHA-256哈希处理
            const hashedPassword = CryptoJS.SHA256(plainPassword).toString();
            
            // 发送哈希后的密码到后端进行验证
            socket.emit('verify_password', { password: hashedPassword, hashed: true });
            
            socket.once('verify_password', (response) => {
                if (response.success) {
                    userRole = 'owner';
                    document.querySelector('.add-danmu-btn-container').style.display = 'block';
                    renderDanmu();
                    document.getElementById('password-error').classList.remove('show');
                } else {
                    const errorElement = document.getElementById('password-error');
                    errorElement.textContent = response.message || '密码错误';
                    errorElement.classList.add('show');
                    setTimeout(() => {
                        errorElement.classList.remove('show');
                    }, 3000);
                }
            });
        };

        document.getElementById('toggle-btn').onclick = () => {
            showNonWaiting = !showNonWaiting; // 切换显示/隐藏状态
            renderDanmu(); // 重新渲染弹幕
        };

        function showAccountPasswordDialog(data, uid) {
            const overlay = document.createElement('div');
            overlay.className = 'acps-dialog-overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <p><span id="current-account">${data.account}</span></p>
                <p><span id="current-password">${data.password}</span></p>
                <input type="text" id="acps-edit" placeholder="输入新的账号或密码">
                <button id="acps-save">保存</button>
                <button id="acps-cancel">取消</button>
            `;

            // 添加延时以触发动画
            requestAnimationFrame(() => {
                overlay.classList.add('show');
                dialog.classList.add('show');
            });

            // 添加键盘事件监听
            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    saveButton.click();
                } else if (e.key === 'Escape') {
                    cancelButton.click();
                }
            };
            document.addEventListener('keydown', handleKeydown);

            const saveButton = dialog.querySelector('#acps-save');
            const cancelButton = dialog.querySelector('#acps-cancel');
            const inputField = dialog.querySelector('#acps-edit');

            saveButton.onclick = () => {
                const newText = inputField.value;
                if (newText) {
                    socket.emit('update_acps', {
                        index: uid,
                        text: newText
                    });
                    closeDialog();
                } else {
                    //alert('请输入新的账号或密码');
                }
            };

            cancelButton.onclick = () => {
                closeDialog();
            };

            const closeDialog = () => {
                document.removeEventListener('keydown', handleKeydown);
                overlay.classList.remove('show');
                dialog.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    dialog.remove();
                }, 300);
            };

            document.body.appendChild(dialog);
        }

        socket.on('update', (data) => {
            renderDanmu(data);
        });
        
        socket.on('get_acps', (response) => {
            console.log('收到账密数据:', response);
            if (response && response.data) {
                showAccountPasswordDialog(response.data, response.uid);
            } else {
                alert('获取账密数据失败');
            }
        });
        
        socket.on('update_acps', (response) => {
            if (response.success) {
                //alert('账号密码更新成功');
            } else {
                //alert('账号密码更新失败');
            }
        });

        // 添加弹幕响应事件
        socket.on('add_danmu', (response) => {
            if (response.success) {
                alert('添加弹幕成功');
            } else {
                alert(response.message || '添加弹幕失败');
            }
        });

        // 全局变量存储最新的弹幕数据
        let currentDanmuData = null;

        socket.on('update', (data) => {
            currentDanmuData = data; // 保存最新数据
            renderDanmu(data);
        });

        function renderDanmu(data) {
            // 如果没有传入数据，使用最新保存的数据
            if (!data) {
                data = currentDanmuData;
            }
            
            // 如果没有数据可用，直接返回
            if (!data || !data.uid) return;
            
            danmuContainer.innerHTML = ''; // 清空现有内容
            data.uid.forEach((uid, index) => {
                if (!showNonWaiting && data.status[index] !== 'waiting') {
                    return; // 如果隐藏非等待状态且当前状态不是 'waiting'，则跳过
                }
                
                // 如果状态为notdisplay，跳过该项不显示
                if (data.status[index] === 'notdisplay') {
                    return;
                }

                const item = document.createElement('div');
                item.className = 'danmu-item';

                // 昵称
                const nickname = document.createElement('span');
                nickname.textContent = `${data.nickname[index]}: `;
                nickname.className = 'nickname';

                // 弹幕内容
                const text = document.createElement('span');
                text.textContent = `${data.text[index]}`;
                text.className = 'text';

                // 状态
                const status = document.createElement('span');
                status.textContent = `      ${data.status[index]}`;
                status.className = 'status';

                // 创建时间
                const createtime = document.createElement('span');
                createtime.textContent = `----${data.createtime[index].slice(5, 16)}`;
                createtime.className = 'createtime';

                // 如果用户是"主人"，显示操作按钮
                if (userRole === 'owner') {
                    const actions = document.createElement('div');
                    actions.className = 'actions';

                    // 删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '删除';
                    deleteBtn.onclick = () => {
                        socket.emit('delete', {
                            index: uid 
                        });
                    };

                    // 编辑按钮
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '编辑';
                    editBtn.onclick = () => {
                        const newText = prompt('请输入新的弹幕内容:', data.text[index]);
                        if (newText) {
                            socket.emit('edit', {
                                index: uid, 
                                text: newText
                            });
                        }
                    };

                    // 完成按钮
                    const completedBtn = document.createElement('button');
                    completedBtn.textContent = '完成';
                    completedBtn.onclick = () => {
                        socket.emit('completed', {
                            index: uid 
                        });
                    };
                    // 账密按钮
                    const ac_ps_Btn = document.createElement('button');
                    ac_ps_Btn.textContent = '账密';
                    ac_ps_Btn.onclick = () => {
                        // 然后发送WebSocket事件获取数据
                        socket.emit('get_acps', {
                            index: uid
                        });
                    };
                    actions.appendChild(deleteBtn);
                    actions.appendChild(completedBtn);
                    actions.appendChild(editBtn);
                    actions.appendChild(ac_ps_Btn);

                    item.appendChild(actions);
                }

                item.appendChild(nickname);
                item.appendChild(text);
                item.appendChild(status);
                item.appendChild(createtime);

                danmuContainer.appendChild(item);
            });
        }
        // 添加弹幕按钮点击事件
        document.getElementById('add-danmu-btn').onclick = () => {
            showAddDanmuDialog();
        };

        // 显示添加弹幕对话框
        function showAddDanmuDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'acps-dialog-overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <h3>添加弹幕</h3>
                <input type="text" id="add-nickname" placeholder="输入昵称">
                <input type="text" id="add-text" placeholder="输入弹幕内容">
                <button id="add-save">保存</button>
                <button id="add-cancel">取消</button>
            `;

            // 添加延时以触发动画
            requestAnimationFrame(() => {
                overlay.classList.add('show');
                dialog.classList.add('show');
            });

            const saveButton = dialog.querySelector('#add-save');
            const cancelButton = dialog.querySelector('#add-cancel');
            const nicknameField = dialog.querySelector('#add-nickname');
            const textField = dialog.querySelector('#add-text');

            // 添加键盘事件监听
            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    saveButton.click();
                } else if (e.key === 'Escape') {
                    cancelButton.click();
                }
            };
            document.addEventListener('keydown', handleKeydown);

            saveButton.onclick = () => {
                const nickname = nicknameField.value;
                const text = textField.value;
                if (nickname && text) {
                    socket.emit('add_danmu', {
                        nickname: nickname,
                        text: text
                    });
                    closeDialog();
                } else {
                    alert('昵称和弹幕内容不能为空');
                }
            };

            cancelButton.onclick = () => {
                closeDialog();
            };

            const closeDialog = () => {
                document.removeEventListener('keydown', handleKeydown);
                overlay.classList.remove('show');
                dialog.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    dialog.remove();
                }, 300);
            };

            document.body.appendChild(dialog);
        }
        // 添加全局快捷键监听
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'i') {
                e.preventDefault();
                showSettingsDialog();
            }
        });

        // 设置按钮点击事件
        document.getElementById('settings-btn').onclick = () => {
            showSettingsDialog();
        };

        // 显示设置窗口
        function showSettingsDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'acps-dialog-overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <h3>快捷键设置</h3>
                <div class="settings-item">
                    <label>添加弹幕快捷键：</label>
                    <input type="text" id="add-danmu-shortcut" placeholder="请按下快捷键组合" readonly>
                </div>
                <div class="settings-item">
                    <label>切换显示状态快捷键：</label>
                    <input type="text" id="toggle-shortcut" placeholder="请按下快捷键组合" readonly>
                </div>
                <div class="settings-actions">
                    <button id="settings-save">保存</button>
                    <button id="settings-cancel">取消</button>
                </div>
            `;

            requestAnimationFrame(() => {
                overlay.classList.add('show');
                dialog.classList.add('show');
            });

            const closeDialog = () => {
                overlay.classList.remove('show');
                dialog.classList.remove('show');
                setTimeout(() => {
                    overlay.remove();
                    dialog.remove();
                }, 300);
            };

            // 快捷键输入处理
            const shortcutInputs = dialog.querySelectorAll('input[type="text"]');
            shortcutInputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    e.preventDefault();
                    const keys = [];
                    if (e.ctrlKey) keys.push('Ctrl');
                    if (e.shiftKey) keys.push('Shift');
                    if (e.altKey) keys.push('Alt');
                    if (e.key !== 'Control' && e.key !== 'Shift' && e.key !== 'Alt') {
                        keys.push(e.key.toUpperCase());
                    }
                    input.value = keys.join('+');
                });
            });

            dialog.querySelector('#settings-save').onclick = () => {
                // 保存快捷键设置的逻辑
                closeDialog();
            };

            dialog.querySelector('#settings-cancel').onclick = closeDialog;

            document.body.appendChild(dialog);
        }
    </script>
</body>
</html>