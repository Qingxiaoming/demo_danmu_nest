<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>----</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1></h1>
    <div class="login-container">
        <input type="password" id="login-password" placeholder="输入密码">
        <button id="login-btn">Start</button>
        <div id="password-error" class="error-message"></div>
    </div>
    <div class="toggle-container">
        <button id="toggle-btn">O</button>
    </div>
    <div id="danmu-container"></div>
    <style>
        .login-container {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .error-message {
            color: #ff4444;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 8px;
        }
        .error-message.show {
            opacity: 1;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const danmuContainer = document.getElementById('danmu-container');
        const socket = io('http://127.0.0.1:5052');
        let userRole = 'guest'; // 默认为游客模式
        let showNonWaiting = true; // 默认显示所有状态

        socket.on('connect', () => {
            console.log('连接到 Socket.IO 服务器');
        });
        
        document.getElementById('login-btn').onclick = () => {
            const password = document.getElementById('login-password').value;
            socket.emit('verify_password', { password });
            socket.once('verify_password', (response) => {
                if (response.success) {
                    userRole = 'owner';
                    renderDanmu();
                    document.getElementById('password-error').classList.remove('show');
                } else {
                    const errorElement = document.getElementById('password-error');
                    errorElement.textContent = response.message || '密码错误';
                    errorElement.classList.add('show');
                    setTimeout(() => {
                        errorElement.classList.remove('show');
                    }, 3000);
                }
            });
        };

        document.getElementById('toggle-btn').onclick = () => {
            showNonWaiting = !showNonWaiting; // 切换显示/隐藏状态
            renderDanmu(); // 重新渲染弹幕
        };

        function showAccountPasswordDialog(data, uid) {
            const dialog = document.createElement('div');
            dialog.className = 'acps-dialog';
            dialog.innerHTML = `
                <p><span id="current-account">${data.account}</span></p>
                <p><span id="current-password">${data.password}</span></p>
                <input type="text" id="acps-edit" placeholder="输入新的账号或密码">
                <button id="acps-save">保存</button>
                <button id="acps-cancel">取消</button>
            `;

            const saveButton = dialog.querySelector('#acps-save');
            const cancelButton = dialog.querySelector('#acps-cancel');
            const inputField = dialog.querySelector('#acps-edit');

            saveButton.onclick = () => {
                const newText = inputField.value;
                if (newText) {
                    socket.emit('update_acps', {
                        index: uid,
                        text: newText
                    });
                    dialog.remove();
                } else {
                    //alert('请输入新的账号或密码');
                }
            };

            cancelButton.onclick = () => {
                dialog.remove();
            };

            document.body.appendChild(dialog);
        }

        socket.on('update', (data) => {
            renderDanmu(data);
        });
        
        socket.on('get_acps', (response) => {
            console.log('收到账密数据:', response);
            if (response && response.data) {
                showAccountPasswordDialog(response.data, response.uid);
            } else {
                alert('获取账密数据失败');
            }
        });
        
        socket.on('update_acps', (response) => {
            if (response.success) {
                //alert('账号密码更新成功');
            } else {
                //alert('账号密码更新失败');
            }
        });

        // 全局变量存储最新的弹幕数据
        let currentDanmuData = null;

        socket.on('update', (data) => {
            currentDanmuData = data; // 保存最新数据
            renderDanmu(data);
        });

        function renderDanmu(data) {
            // 如果没有传入数据，使用最新保存的数据
            if (!data) {
                data = currentDanmuData;
            }
            
            // 如果没有数据可用，直接返回
            if (!data || !data.uid) return;
            
            danmuContainer.innerHTML = ''; // 清空现有内容
            data.uid.forEach((uid, index) => {
                if (!showNonWaiting && data.status[index] !== 'waiting') {
                    return; // 如果隐藏非等待状态且当前状态不是 'waiting'，则跳过
                }
                
                // 如果状态为notdisplay，跳过该项不显示
                if (data.status[index] === 'notdisplay') {
                    return;
                }

                const item = document.createElement('div');
                item.className = 'danmu-item';

                // 昵称
                const nickname = document.createElement('span');
                nickname.textContent = `${data.nickname[index]}: `;
                nickname.className = 'nickname';

                // 弹幕内容
                const text = document.createElement('span');
                text.textContent = `${data.text[index]}`;
                text.className = 'text';

                // 状态
                const status = document.createElement('span');
                status.textContent = `      ${data.status[index]}`;
                status.className = 'status';

                // 创建时间
                const createtime = document.createElement('span');
                createtime.textContent = `----${data.createtime[index]}`;
                createtime.className = 'createtime';

                // 如果用户是"主人"，显示操作按钮
                if (userRole === 'owner') {
                    const actions = document.createElement('div');
                    actions.className = 'actions';

                    // 删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '删除';
                    deleteBtn.onclick = () => {
                        socket.emit('delete', {
                            index: uid 
                        });
                    };

                    // 编辑按钮
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '编辑';
                    editBtn.onclick = () => {
                        const newText = prompt('请输入新的弹幕内容:', data.text[index]);
                        if (newText) {
                            socket.emit('edit', {
                                index: uid, 
                                text: newText
                            });
                        }
                    };

                    // 完成按钮
                    const completedBtn = document.createElement('button');
                    completedBtn.textContent = '完成';
                    completedBtn.onclick = () => {
                        socket.emit('completed', {
                            index: uid 
                        });
                    };
                    // 账密按钮
                    const ac_ps_Btn = document.createElement('button');
                    ac_ps_Btn.textContent = '账密';
                    ac_ps_Btn.onclick = () => {
                        // 然后发送WebSocket事件获取数据
                        socket.emit('get_acps', {
                            index: uid
                        });
                    };
                    actions.appendChild(deleteBtn);
                    actions.appendChild(completedBtn);
                    actions.appendChild(editBtn);
                    actions.appendChild(ac_ps_Btn);

                    item.appendChild(actions);
                }

                item.appendChild(nickname);
                item.appendChild(text);
                item.appendChild(status);
                item.appendChild(createtime);

                danmuContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>